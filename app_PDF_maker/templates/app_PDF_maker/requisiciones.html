{% extends 'app_PDF_maker/base.html' %}

{% block title %}Requisiciones - Dreacht Hub{% endblock %}

{% block extra_head %}
<style>
    body, html { 
        margin: 0; 
        padding: 0; 
        height: 100%; 
        overflow-x: hidden;
    }
    #pdf-container { 
        position: relative; 
        width: 100%; 
        height: auto; 
        min-height: 100vh;
        overflow: visible; 
        background: #f0f0f0;
    }
    #pdf-canvas { 
        display: block; 
        margin: 0 auto; 
        max-width: 100%; 
        height: auto;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #form-overlay { 
        position: absolute; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        pointer-events: none;
        z-index: 5;
    }
    .campo {
        position: absolute;
        font-size: 14px;
        border: 1px solid #777;
        border-radius: 4px;
        padding: 3px 6px;
        background-color: rgba(255, 255, 255, 0.9);
        pointer-events: auto;
        box-sizing: border-box;
        z-index: 10;
    }
    #campo-fecha_soli, #campo-fecha_util, #campo-fecha_surt { text-align: center; }
    #submit-btn {
        position: fixed; 
        bottom: 20px; 
        left: 50%; 
        transform: translateX(-50%);
        padding: 8px 18px; 
        font-weight: bold;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div id="pdf-container">
    <canvas id="pdf-canvas"></canvas>

    <form id="form-overlay" method="POST" action="{% url 'requisiciones' %}">
        {% csrf_token %}

        <!-- Campos (coordenadas relativas %) -->
        {{ form.obra }}
        {{ form.ubicacion }}
        {{ form.numero_de_articulos }}
        {{ form.fecha_soli }}
        {{ form.fecha_util }}
        {{ form.fecha_surt }}
        {{ form.contratista_soli }}
        {{ form.contratista_auto }}
        {{ form.area_util }}
        {{ form.observaciones }}


        <!-- Campos para items (14 filas) -->
        {% for i in "1234567891011121314" %}
        <input type="text" name="item{{ i }}_descripcion" placeholder="Descripción" class="campo" id="campo-item{{ i }}_descripcion">
        <input type="text" name="item{{ i }}_unidad" placeholder="Unidad" class="campo" id="campo-item{{ i }}_unidad">
        <input type="number" step="0.01" name="item{{ i }}_cantidad" placeholder="Cantidad" class="campo" id="campo-item{{ i }}_cantidad">
        {% endfor %}

        <button id="submit-btn" type="submit" class="btn btn-danger">Generar PDF</button>
    </form>

    {% if form.errors %}
    <div style="position: fixed; top: 10px; right: 10px; background: red; color: white; padding: 10px; border-radius: 5px;">
        <strong>Errores en el formulario:</strong>
        <ul>
            {% for field in form %}
                {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<script>
const url = '/static/media/requiscion_template.pdf';
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

const canvas = document.getElementById('pdf-canvas');
const ctx = canvas.getContext('2d');
const overlayForm = document.getElementById('form-overlay');
const container = document.getElementById('pdf-container');
const pdfOriginal = { width: 612, height: 792 };

const campos = {
    obra: { x: 178, y: 640 },
    ubicacion: { x: 192, y: 616 },
    numero_de_articulos: { x: 230, y: 592 },
    fecha_soli: { x: 480, y: 640 },
    fecha_util: { x: 480, y: 616 },
    fecha_surt: { x: 480, y: 592 },
    contratista_soli: { x: 170, y: 562 },
    contratista_auto: { x: 113, y: 533 },
    area_util: { x: 163, y: 505 },
    observaciones: { x: 464, y: 64},
    // Campos para items (14 filas)
    item1_descripcion: { x: 46, y: 430 },
    item1_unidad: { x: 394, y: 430 },
    item1_cantidad: { x: 315, y: 430 },
    item2_descripcion: { x: 46, y: 401 },
    item2_unidad: { x: 394, y: 401 },
    item2_cantidad: { x: 315, y: 401 },
    item3_descripcion: { x: 46, y: 373 },
    item3_unidad: { x: 394, y: 373 },
    item3_cantidad: { x: 315, y: 373 },
    item4_descripcion: { x: 46, y: 345 },
    item4_unidad: { x: 394, y: 345 },
    item4_cantidad: { x: 315, y: 345 },
    item5_descripcion: { x: 46, y: 317 },
    item5_unidad: { x: 394, y: 317 },
    item5_cantidad: { x: 315, y: 317 },
    item6_descripcion: { x: 46, y: 289 },
    item6_unidad: { x: 394, y: 289 },
    item6_cantidad: { x: 315, y: 289 },
    item7_descripcion: { x: 46, y: 260 },
    item7_unidad: { x: 394, y: 260 },
    item7_cantidad: { x: 315, y: 260 },
    item8_descripcion: { x: 46, y: 232 },
    item8_unidad: { x: 394, y: 232 },
    item8_cantidad: { x: 315, y: 232 },
    item9_descripcion: { x: 46, y: 203 },
    item9_unidad: { x: 394, y: 203 },
    item9_cantidad: { x: 315, y: 203 },
    item10_descripcion: { x: 46, y: 178 },
    item10_unidad: { x: 394, y: 178 },
    item10_cantidad: { x: 315, y: 178 },
    item11_descripcion: { x: 46, y: 150 },
    item11_unidad: { x: 394, y: 150 },
    item11_cantidad: { x: 315, y: 150 },
    item12_descripcion: { x: 46, y: 122 },
    item12_unidad: { x: 394, y: 122 },
    item12_cantidad: { x: 315, y: 122 },
    item13_descripcion: { x: 46, y: 94 },
    item13_unidad: { x: 394, y: 94 },
    item13_cantidad: { x: 315, y: 94 },
    item14_descripcion: { x: 46, y: 66 },
    item14_unidad: { x: 394, y: 66 },
    item14_cantidad: { x: 315, y: 66 }
};

const fieldScales = {
    obra: { widthScale: 1.0, heightScale: 0.7, fontScale: 1.0 },
    ubicacion: { widthScale: 0.94, heightScale: 0.7, fontScale: 1.0 },
    numero_de_articulos: { widthScale: 0.77, heightScale: 0.7, fontScale: 1.0 },
    fecha_soli: { widthScale: 0.4, heightScale: 0.7, fontScale: 1.0 },
    fecha_util: { widthScale: 0.4, heightScale: 0.7, fontScale: 1.0 },
    fecha_surt: { widthScale: 0.4, heightScale: 0.7, fontScale: 1.0 },
    contratista_soli: { widthScale: 1.32, heightScale: 0.7, fontScale: 1.0 },
    contratista_auto: { widthScale: 1.58, heightScale: 0.7, fontScale: 1.0 },
    area_util: { widthScale: 1.35, heightScale: 0.7, fontScale: 1.0 },
    fecha_hora_creacion: { widthScale: 1.2, heightScale: 0.7, fontScale: 0.9 },
    observaciones: { widthScale: 0.55, heightScale: 15, fontScale: 1.0 },
    item_descripcion: { widthScale: 1.21, heightScale: 0.9, fontScale: 1.0 },
    item_unidad: { widthScale: 0.311, heightScale: 0.9, fontScale: 1.0 },
    item_cantidad: { widthScale: 0.343, heightScale: 0.9, fontScale: 1.0 }
};

// SOLUCIÓN COMPLETA - Reiniciar todo el enfoque
function renderPDF(url) {
    // Limpiar completamente
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Resetear estilos del contenedor
    container.style.position = 'relative';
    container.style.width = '100%';
    container.style.height = 'auto';
    container.style.overflow = 'visible';

    pdfjsLib.getDocument(url).promise.then(pdf => {
        pdf.getPage(1).then(page => {
            const viewportUnscaled = page.getViewport({ scale: 1 });
            
            // Usar escala completa
            const scale = Math.min(
                window.innerWidth / viewportUnscaled.width,
                window.innerHeight / viewportUnscaled.height
            );
            
            const viewport = page.getViewport({ scale });

            // Configurar canvas con dimensiones exactas
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            canvas.style.width = viewport.width + 'px';
            canvas.style.height = viewport.height + 'px';
            canvas.style.display = 'block';
            canvas.style.margin = '0 auto';

            console.log('Canvas dimensions:', canvas.width, canvas.height);
            console.log('Viewport scale:', scale);

            const renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };

            page.render(renderContext).promise.then(() => {
                console.log('PDF rendered, positioning fields...');
                positionFieldsDirect();
                
                window.addEventListener('resize', function() {
                    setTimeout(() => renderPDF(url), 100);
                });
            });
        });
    }).catch(err => console.error("Error cargando PDF:", err));
}

// NUEVA FUNCIÓN - Posicionamiento directo y simple
function positionFieldsDirect() {
    console.log('=== STARTING FIELD POSITIONING ===');
    
    const canvasRect = canvas.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();
    
    console.log('Canvas rect:', canvasRect);
    console.log('Container rect:', containerRect);

    // POSICIONAR EL OVERLAY SOBRE EL CANVAS EXACTAMENTE
    overlayForm.style.position = 'absolute';
    overlayForm.style.left = canvasRect.left - containerRect.left + 'px';
    overlayForm.style.top = canvasRect.top - containerRect.top + 'px';
    overlayForm.style.width = canvasRect.width + 'px';
    overlayForm.style.height = canvasRect.height + 'px';
    overlayForm.style.pointerEvents = 'auto';
    overlayForm.style.overflow = 'visible';

    console.log('Overlay positioned at:', {
        left: overlayForm.style.left,
        top: overlayForm.style.top,
        width: overlayForm.style.width,
        height: overlayForm.style.height
    });

    // POSICIONAR CADA CAMPO
    for (const key in campos) {
        const elem = document.getElementById(`campo-${key}`);
        if (!elem) {
            console.warn('Element not found:', `campo-${key}`);
            continue;
        }

        const pdfPos = campos[key];
        
        // Calcular posición relativa al PDF original
        const x_percent = pdfPos.x / pdfOriginal.width;
        const y_percent = pdfPos.y / pdfOriginal.height;
        
        // Convertir a píxeles en el canvas renderizado
        const x_px = x_percent * canvasRect.width;
        const y_px = y_percent * canvasRect.height;
        
        // Invertir Y coordinate (PDF vs HTML coordinate system)
        const top_px = canvasRect.height - y_px;

        console.log(`Field ${key}:`, {
            pdfPos,
            percentages: { x_percent, y_percent },
            calculated: { x_px, y_px, top_px }
        });

        // Determinar escalas
        let scaleKey = key;
        if (key.startsWith('item')) {
            if (key.includes('_descripcion')) scaleKey = 'item_descripcion';
            else if (key.includes('_unidad')) scaleKey = 'item_unidad';
            else if (key.includes('_cantidad')) scaleKey = 'item_cantidad';
        }

        const { widthScale, heightScale, fontScale } = fieldScales[scaleKey] || { widthScale: 1.0, heightScale: 0.7, fontScale: 1.0 };
        
        // Calcular dimensiones
        const width_px = 220 * (canvasRect.width / pdfOriginal.width) * widthScale;
        const height_px = 26 * (canvasRect.height / pdfOriginal.height) * heightScale;

        // APLICAR ESTILOS DIRECTAMENTE
        elem.style.position = 'absolute';
        elem.style.left = x_px + 'px';
        elem.style.top = (top_px - height_px) + 'px'; // Ajustar para que el campo esté sobre la posición
        elem.style.width = width_px + 'px';
        elem.style.height = height_px + 'px';
        elem.style.boxSizing = 'border-box';
        elem.style.fontSize = (12 * (canvasRect.height / pdfOriginal.height) * fontScale) + 'px';
        elem.style.zIndex = '10';
        
        console.log(`Field ${key} positioned at:`, {
            left: elem.style.left,
            top: elem.style.top,
            width: elem.style.width,
            height: elem.style.height
        });

        // DEBUG VISUAL - agregar borde rojo a campos problemáticos
        if (key.includes('item10') || key.includes('item11') || key.includes('item12') || key.includes('item13') || key.includes('item14')) {
            elem.style.border = '2px solid red';
            console.log(`PROBLEMATIC FIELD ${key}:`, {
                position: { x_px, y_px, top_px },
                dimensions: { width_px, height_px },
                actualStyle: {
                    left: elem.style.left,
                    top: elem.style.top,
                    width: elem.style.width,
                    height: elem.style.height
                }
            });
        }
    }
    
    console.log('=== FIELD POSITIONING COMPLETE ===');
}

// Iniciar
setTimeout(() => renderPDF(url), 100);
</script>
{% endblock %}