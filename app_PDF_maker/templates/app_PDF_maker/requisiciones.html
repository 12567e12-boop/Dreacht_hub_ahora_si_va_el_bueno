{% extends 'app_PDF_maker/base.html' %}

{% block title %}Requisiciones - Dreacht Hub{% endblock %}

{% block extra_head %}
<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100%;
    }

    #pdf-container {
        position: relative;
        width: 100%;
        height: 100vh;
        overflow: hidden;
    }

    #pdf-canvas {
        display: block;
        margin: 0 auto;
        max-width: 100%;
        height: auto;
    }

    #form-overlay {
        position: absolute;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* inputs los reactivamos con JS */
    }

    .campo {
        position: absolute;
        font-size: 14px;
        border: 1px solid #777;
        border-radius: 4px;
        padding: 3px 6px;
        background-color: rgba(255, 255, 255, 0.8);
        pointer-events: auto; /* habilita interacción */
        box-sizing: border-box;
    }

    
    #campo-fecha_soli,
    #campo-fecha_util,
    #campo-fecha_surt
     {
        text-align: center;
    }

    #submit-btn {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 8px 18px;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div id="pdf-container">
    <canvas id="pdf-canvas"></canvas>

    <form id="form-overlay" method="POST" action="{% url 'requisiciones' %}">
        {% csrf_token %}

        <!-- Campos (coordenadas relativas %) -->
        <input type="text" name="obra" placeholder="obra" class="campo" id="campo-obra">
        <input type="text" name="ubicacion" placeholder="ubicacion" class="campo" id="campo-ubicacion">
        <input type="text" name="numero_de_articulos" placeholder="numero de articulos" class="campo" id="campo-numero_de_articulos">
        <input type="date" name="fecha_soli"  class="campo" id="campo-fecha_soli">
        <input type="date" name="fecha_util"  class="campo" id="campo-fecha_util">
        <input type="date" name="fecha_surt"  class="campo" id="campo-fecha_surt">
        <input type="text" name="contratista_soli" placeholder="Nombre completo" class="campo" id="campo-contratista_soli">
        <input type="text" name="contratista_auto" placeholder="Nombre completo" class="campo" id="campo-contratista_auto">
        <input type="text" name="area_util" placeholder="Ej. traumatologia" class="campo" id="campo-area_util">

        <button id="submit-btn" type="submit" class="btn btn-danger">Generar PDF</button>
    </form>


</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<script>
const url = '/static/media/requiscion_template.pdf';
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

const canvas = document.getElementById('pdf-canvas');
const ctx = canvas.getContext('2d');
const overlayForm = document.getElementById('form-overlay');
const container = document.getElementById('pdf-container');

// Tamaño original del PDF en puntos (letter)
const pdfOriginal = { width: 612, height: 792 };

// Coordenadas en puntos PDF: AJUSTA ESTOS VALORES a tu plantilla
const campos = {
    obra: { x: 178, y: 640 },
    ubicacion: { x: 192, y: 616},
    numero_de_articulos: { x: 230, y: 592 },
    fecha_soli:  { x: 480, y: 640 },
    fecha_util:  { x: 480, y: 616 },
    fecha_surt:  { x: 480, y: 592 },
    contratista_soli: { x: 170, y: 562 },
    contratista_auto: {x: 113, y: 533 },
    area_util : {x: 163, y: 505}


};

// Fixed field sizes    
const fieldScales = {
    obra: { widthScale: 1.0, heightScale: 0.7, fontScale: 1.0 },
    ubicacion: { widthScale: 0.94, heightScale: 0.7, fontScale: 1.0 },
    numero_de_articulos: { widthScale: 0.77, heightScale: 0.7, fontScale: 1.0 },
    fecha_soli: { widthScale: 0.4, heightScale: 0.7, fontScale: 1.0 },
    fecha_util: { widthScale: 0.4, heightScale: 0.7, fontScale: 1.0 },
    fecha_surt: { widthScale: 0.4, heightScale: 0.7, fontScale: 1.0 },
    contratista_soli: { widthScale: 1.32, heightScale: 0.7, fontScale: 1.0 },
    contratista_auto: { widthScale: 1.58, heightScale: 0.7, fontScale: 1.0 },
    area_util: { widthScale: 1.35, heightScale: 0.7, fontScale: 1.0 },
};

// Flag de debug: dibuja cajas rojas donde se posicionan los campos
const DEBUG_DRAW_BOXES = false;

function renderPDF(url) {
    pdfjsLib.getDocument(url).promise.then(pdf => {
        pdf.getPage(1).then(page => {
            const viewportUnscaled = page.getViewport({ scale: 1 });
            // Calcular scale para que quepa en ancho y alto del viewport (90% para margen)
            const scaleWidth = (window.innerWidth * 0.9) / viewportUnscaled.width;
            const scaleHeight = (window.innerHeight * 0.9) / viewportUnscaled.height;
            const scale = Math.min(scaleWidth, scaleHeight);
            const viewport = page.getViewport({ scale });

            canvas.width = viewport.width;
            canvas.height = viewport.height;
            canvas.style.width = `${viewport.width}px`;
            canvas.style.height = `${viewport.height}px`;

            const renderContext = { canvasContext: ctx, viewport };
            page.render(renderContext).promise.then(() => {
                syncOverlayToCanvas();
                positionFields();
                // Reposicionar en resize (con debounce)
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        renderPDF(url);
                    }, 120);
                });

            });
        });
    }).catch(err => {
        console.error("Error cargando PDF:", err);
    });
}

function syncOverlayToCanvas() {
    // Obtener rect del canvas relativo al contenedor
    const canvasRect = canvas.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();

    // Posicionar overlay exactamente encima del canvas (en coordenadas del contenedor)
    const left = canvasRect.left - containerRect.left;
    const top  = canvasRect.top  - containerRect.top;

    overlayForm.style.position = 'absolute';
    overlayForm.style.left = `${left}px`;
    overlayForm.style.top  = `${top}px`;
    overlayForm.style.width = `${canvasRect.width}px`;
    overlayForm.style.height = `${canvasRect.height}px`;
    overlayForm.style.pointerEvents = 'auto'; // permitir interacción
    overlayForm.style.overflow = 'visible';
}

function positionFields() {
    // Obtener tamaño actual del canvas dentro del overlay
    const overlayRect = overlayForm.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();
    const w = canvasRect.width;
    const h = canvasRect.height;

    // Para cada campo, calcular su posición en pixeles relativa al overlay
    for (const key in campos) {
        const elem = document.getElementById(`campo-${key}`);
        if (!elem) continue;
        const pdfPos = campos[key];

        // Escala: convertir puntos PDF -> pixels del canvas
        const x_px = (pdfPos.x / pdfOriginal.width) * w;
        const y_px = (pdfPos.y / pdfOriginal.height) * h;

        // Invertir Y: pdf y=0 abajo => screen y = canvasHeight - y_px
        const top_px = h - y_px;

        // Ajustar para que el input quede centrado verticalmente respecto a su altura
        // Puedes cambiar width_base o setear estilo width en CSS si quieres fijo
        const { widthScale, heightScale, fontScale } = fieldScales[key] || { widthScale: 1.0, heightScale: 0.7, fontScale: 1.0 };
        const width_px = 220 * (w / pdfOriginal.width) * widthScale; // ancho base escalado con scale
        const height_px = 26 * (h / pdfOriginal.height) * heightScale;

        elem.style.position = 'absolute';
        elem.style.left = `${x_px}px`;
        // Restar height_px para que el texto no salga fuera; ajustar si es necesario
        elem.style.top  = `${top_px - height_px}px`;
        elem.style.width = `${width_px}px`;
        elem.style.height = `${height_px}px`;
        elem.style.boxSizing = 'border-box';
        elem.style.fontSize = `${12 * (h / pdfOriginal.height) * fontScale}px`;
    }

    if (DEBUG_DRAW_BOXES) drawDebugBoxes();
}

function drawDebugBoxes() {
    // Dibuja rectángulos en el canvas para ayudarte a calibrar (se borra al re-render)
    ctx.save();
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 1;
    for (const key in campos) {
        const pdfPos = campos[key];
        const w = canvas.getBoundingClientRect().width;
        const h = canvas.getBoundingClientRect().height;
        const x_px = (pdfPos.x / pdfOriginal.width) * w;
        const y_px = (pdfPos.y / pdfOriginal.height) * h;
        const top_px = h - y_px;
        const width_px = 220 * (w / pdfOriginal.width);
        const height_px = 26 * (h / pdfOriginal.height);
        ctx.strokeRect(x_px, top_px - height_px, width_px, height_px);
    }
    ctx.restore();
}

// Inicializar
renderPDF(url);


</script>
{% endblock %}
