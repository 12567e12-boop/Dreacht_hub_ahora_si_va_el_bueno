{% extends 'app_PDF_maker/base.html' %}

{% block title %}Requisiciones - Dreacht Hub{% endblock %}

{% block extra_head %}
<style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #pdf-container { position: relative; width: 100%; height: 100vh; overflow: hidden; }
    #pdf-canvas { display: block; margin: 0 auto; max-width: 100%; height: auto; }
    #form-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .campo {
        position: absolute;
        font-size: 14px;
        border: 1px solid #777;
        border-radius: 4px;
        padding: 3px 6px;
        background-color: rgba(255, 255, 255, 0.8);
        pointer-events: auto;
        box-sizing: border-box;
    }
    #campo-fecha_soli, #campo-fecha_util, #campo-fecha_surt { text-align: center; }
    #submit-btn {
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        padding: 8px 18px; font-weight: bold;
    }

</style>
{% endblock %}

{% block content %}
<div id="pdf-container">
    <canvas id="pdf-canvas"></canvas>

    <form id="form-overlay" method="POST" action="{% url 'requisiciones' %}">
        {% csrf_token %}

        <!-- Campos (coordenadas relativas %) -->
        {{ form.obra }}
        {{ form.ubicacion }}
        {{ form.numero_de_articulos }}
        {{ form.fecha_soli }}
        {{ form.fecha_util }}
        {{ form.fecha_surt }}
        {{ form.contratista_soli }}
        {{ form.contratista_auto }}
        {{ form.area_util }}
        {{ form.observaciones }}


        <!-- Campos para items (14 filas) -->
        {% for i in "1234567891011121314" %}
        <input type="text" name="item{{ i }}_descripcion" placeholder="DescripciÃ³n" class="campo" id="campo-item{{ i }}_descripcion">
        <input type="text" name="item{{ i }}_unidad" placeholder="Unidad" class="campo" id="campo-item{{ i }}_unidad">
        <input type="number" step="0.01" name="item{{ i }}_cantidad" placeholder="Cantidad" class="campo" id="campo-item{{ i }}_cantidad">
        {% endfor %}

        <button id="submit-btn" type="submit" class="btn btn-danger">Generar PDF</button>
    </form>

    {% if form.errors %}
    <div style="position: fixed; top: 10px; right: 10px; background: red; color: white; padding: 10px; border-radius: 5px;">
        <strong>Errores en el formulario:</strong>
        <ul>
            {% for field in form %}
                {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
            {% endfor %}
            {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<script>
const url = '/static/media/requiscion_template.pdf';
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

const canvas = document.getElementById('pdf-canvas');
const ctx = canvas.getContext('2d');
const overlayForm = document.getElementById('form-overlay');
const container = document.getElementById('pdf-container');
const pdfOriginal = { width: 612, height: 792 };

const campos = {
    obra: { x: 178, y: 640 },
    ubicacion: { x: 192, y: 616 },
    numero_de_articulos: { x: 230, y: 592 },
    fecha_soli: { x: 480, y: 640 },
    fecha_util: { x: 480, y: 616 },
    fecha_surt: { x: 480, y: 592 },
    contratista_soli: { x: 170, y: 562 },
    contratista_auto: { x: 113, y: 533 },
    area_util: { x: 163, y: 505 },
    fecha_hora_creacion: { x: 450, y: 562 },
    observaciones: { x: 465, y: 195},
    // Campos para items (14 filas, posiciones temporales para ajuste)
    item1_descripcion: { x: 46, y: 430 },
    item1_unidad: { x: 394, y: 430 },
    item1_cantidad: { x: 315, y: 430 },
    item2_descripcion: { x: 46, y: 401 },
    item2_unidad: { x: 394, y: 401 },
    item2_cantidad: { x: 315, y: 401 },
    item3_descripcion: { x: 46, y: 373 },
    item3_unidad: { x: 394, y: 373 },
    item3_cantidad: { x: 315, y: 373 },
    item4_descripcion: { x: 46, y: 345 },
    item4_unidad: { x: 394, y: 345 },
    item4_cantidad: { x: 315, y: 345 },
    item5_descripcion: { x: 46, y: 317 },
    item5_unidad: { x: 394, y: 317 },
    item5_cantidad: { x: 315, y: 317 },
    item6_descripcion: { x: 46, y: 289 },
    item6_unidad: { x: 394, y: 289 },
    item6_cantidad: { x: 315, y: 289 },
    item7_descripcion: { x: 46, y: 260 },
    item7_unidad: { x: 394, y: 260 },
    item7_cantidad: { x: 315, y: 260 },
    item8_descripcion: { x: 46, y: 232 },
    item8_unidad: { x: 394, y: 232 },
    item8_cantidad: { x: 315, y: 232 },
    item9_descripcion: { x: 46, y: 203 },
    item9_unidad: { x: 394, y: 203 },
    item9_cantidad: { x: 315, y: 203 },
    item10_descripcion: { x: 46, y: 178 },
    item10_unidad: { x: 394, y: 178 },
    item10_cantidad: { x: 315, y: 178 },
    item11_descripcion: { x: 46, y: 150 },
    item11_unidad: { x: 394, y: 150 },
    item11_cantidad: { x: 315, y: 150 },
    item12_descripcion: { x: 46, y: 122 },
    item12_unidad: { x: 394, y: 122 },
    item12_cantidad: { x: 315, y: 122 },
    item13_descripcion: { x: 46, y: 94 },
    item13_unidad: { x: 394, y: 94 },
    item13_cantidad: { x: 315, y: 94 },
    item14_descripcion: { x: 46, y: 66 },
    item14_unidad: { x: 394, y: 66 },
    item14_cantidad: { x: 315, y: 66 }
};

const fieldScales = {
    obra: { widthScale: 1.0, heightScale: 0.7, fontScale: 1.0 },
    ubicacion: { widthScale: 0.94, heightScale: 0.7, fontScale: 1.0 },
    numero_de_articulos: { widthScale: 0.77, heightScale: 0.7, fontScale: 1.0 },
    fecha_soli: { widthScale: 0.4, heightScale: 0.7, fontScale: 1.0 },
    fecha_util: { widthScale: 0.4, heightScale: 0.7, fontScale: 1.0 },
    fecha_surt: { widthScale: 0.4, heightScale: 0.7, fontScale: 1.0 },
    contratista_soli: { widthScale: 1.32, heightScale: 0.7, fontScale: 1.0 },
    contratista_auto: { widthScale: 1.58, heightScale: 0.7, fontScale: 1.0 },
    area_util: { widthScale: 1.35, heightScale: 0.7, fontScale: 1.0 },
    fecha_hora_creacion: { widthScale: 1.2, heightScale: 0.7, fontScale: 0.9 },
    observaciones: { widthScale: 0.55, heightScale: 10.0, fontScale: 1.0 },
    item_descripcion: { widthScale: 1.21, heightScale: 0.9, fontScale: 1.0 },
    item_unidad: { widthScale: 0.311, heightScale: 0.9, fontScale: 1.0 },
    item_cantidad: { widthScale: 0.343, heightScale: 0.9, fontScale: 1.0 }
};

const DEBUG_DRAW_BOXES = false;

function renderPDF(url) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    pdfjsLib.getDocument(url).promise.then(pdf => {
        pdf.getPage(1).then(page => {
            const viewportUnscaled = page.getViewport({ scale: 1 });
            const scaleWidth = (window.innerWidth * 0.9) / viewportUnscaled.width;
            const scaleHeight = (window.innerHeight * 0.9) / viewportUnscaled.height;
            const scale = Math.min(scaleWidth, scaleHeight);
            const viewport = page.getViewport({ scale });

            canvas.width = viewport.width;
            canvas.height = viewport.height;
            canvas.style.width = `${viewport.width}px`;
            canvas.style.height = `${viewport.height}px`;

            const renderContext = { canvasContext: ctx, viewport };
            page.render(renderContext).promise.then(() => {
                syncOverlayToCanvas();
                positionFields();
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        renderPDF(url);
                    }, 120);
                });
            });
        });
    }).catch(err => console.error("Error cargando PDF:", err));
}

function syncOverlayToCanvas() {
    const canvasRect = canvas.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();
    overlayForm.style.position = 'absolute';
    overlayForm.style.left = `${canvasRect.left - containerRect.left}px`;
    overlayForm.style.top  = `${canvasRect.top - containerRect.top}px`;
    overlayForm.style.width = `${canvasRect.width}px`;
    overlayForm.style.height = `${canvasRect.height}px`;
    overlayForm.style.pointerEvents = 'auto';
    overlayForm.style.overflow = 'visible';
}

function positionFields() {
    const overlayRect = overlayForm.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();
    const w = canvasRect.width;
    const h = canvasRect.height;

    for (const key in campos) {
        const elem = document.getElementById(`campo-${key}`);
        if (!elem) continue;
        const pdfPos = campos[key];
        const x_px = (pdfPos.x / pdfOriginal.width) * w;
        const y_px = (pdfPos.y / pdfOriginal.height) * h;
        const top_px = h - y_px;

        // Determine scale key based on field type
        let scaleKey = key;
        if (key.startsWith('item') && key.includes('_descripcion')) {
            scaleKey = 'item_descripcion';
        } else if (key.startsWith('item') && key.includes('_unidad')) {
            scaleKey = 'item_unidad';
        } else if (key.startsWith('item') && key.includes('_cantidad')) {
            scaleKey = 'item_cantidad';
        }

        const { widthScale, heightScale, fontScale } = fieldScales[scaleKey] || { widthScale: 1.0, heightScale: 0.7, fontScale: 1.0 };
        const width_px = 220 * (w / pdfOriginal.width) * widthScale;
        const height_px = 26 * (h / pdfOriginal.height) * heightScale;

        elem.style.position = 'absolute';
        elem.style.left = `${x_px}px`;
        elem.style.top  = `${top_px - height_px}px`;
        elem.style.width = `${width_px}px`;
        elem.style.height = `${height_px}px`;
        elem.style.boxSizing = 'border-box';
        elem.style.fontSize = `${12 * (h / pdfOriginal.height) * fontScale}px`;
    }

    if (DEBUG_DRAW_BOXES) drawDebugBoxes();
}

function drawDebugBoxes() {
    ctx.save();
    ctx.strokeStyle = 'red';
    ctx.lineWidth = 1;
    for (const key in campos) {
        const pdfPos = campos[key];
        const w = canvas.getBoundingClientRect().width;
        const h = canvas.getBoundingClientRect().height;
        const x_px = (pdfPos.x / pdfOriginal.width) * w;
        const y_px = (pdfPos.y / pdfOriginal.height) * h;
        const top_px = h - y_px;
        const width_px = 220 * (w / pdfOriginal.width);
        const height_px = 26 * (h / pdfOriginal.height);
        ctx.strokeRect(x_px, top_px - height_px, width_px, height_px);
    }
    ctx.restore();
}

renderPDF(url);
</script>
{% endblock %}
